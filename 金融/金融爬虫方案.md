# é‡‘ä»·çˆ¬è™«é¡¹ç›®æŠ€æœ¯æ–¹æ¡ˆ

å¸®æˆ‘æ¨èä¸€ä¸ªæ–¹æ¡ˆï¼Œæˆ‘æ˜¯å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œä¼šå†™ pythonï¼Œä¹Ÿä¼šå†™ node.jsã€‚ 1.ç¾åœ¨æœ€æµè¡Œçš„æ¯”è¾ƒåˆé€‚çš„ python æˆ–è€… node.js çš„ web é¡µé¢çˆ¬è™«æ˜¯ä»€ä¹ˆæ¡†æ¶ï¼Œæˆ–è€…æ˜¯ç”¨ä»€ä¹ˆåŒ…æ¯”è¾ƒå¥½ï¼Ÿæˆ‘è¦çˆ¬ investing.com çš„é¡µé¢çš„è´¢ç»æ•°æ®é¡µé¢åçˆ¬æ¯”è¾ƒå‰å®³éœ€è¦ç”¨ playwright ï¼Œç„¶åå­˜åˆ° subpae æ•°æ®åº“é‡Œé¢å»ï¼Œéœ€è¦å®šæ—¶æˆ–è€…æˆ‘æ‰‹åŠ¨æ‰§è¡Œ æ¯å¤©æˆ–è€…æ¯åˆ†é’Ÿæ¯å°æ—¶ä¸€æ¬¡ï¼Œå¯èƒ½éƒ¨ç½²åˆ° linux æœåŠ¡å™¨ä¸Šï¼Œä¹Ÿå¯èƒ½ç”¨ window æ‰‹åŠ¨æ‰§è¡Œï¼Œæœ€ååœ¨å‰ç«¯é¡µé¢ä¸Šç›´æ¥ä½¿ç”¨ supabase.js çš„æä¾›çš„ restful æ¥å£è·å–æ•°æ®ã€‚ç”¨ä»€ä¹ˆè¯­è¨€å‘¢ï¼Œä»€ä¹ˆæ¡†æ¶å‘¢ï¼Œæˆ–è€…ç”¨ä»€ä¹ˆåŒ…ï¼Ÿ 2.åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Œè¯´ä¸€ä¸‹ç†ç”±ï¼Œå’Œå¯¹æ¯”çš„åˆ©å¼Šï¼Œéƒ¨ç½² linux ç­‰ç­‰ 3.æˆ‘åªè¦è·å–ä¸€ä¸ªé¡µé¢çš„ä¸€ä¸ªå­—æ®µçš„ æ•°æ® ç„¶åå°±æ˜¯é»„é‡‘çš„çº½çº¦æœŸè´§çš„ä»·æ ¼ï¼Œç„¶åå­˜èµ·æ¥å°±è¡Œï¼Œç„¶åç›´æ¥ç”¨ç½‘é¡µå»è¯·æ±‚ supabase è·å–ï¼Œæœ€åèƒ½ç®€å•å¿«é€Ÿçš„å‡ºä¸€ä¸ªæŠ˜çº¿å›¾æ•°æ®æŠ¥è¡¨æ¥å±•ç¤ºé‡‘ä»·çš„å†å²èµ°åŠ¿ã€‚æˆ‘ä¸€ä¸ªäººå¼€å‘ï¼Œä½†æ˜¯éœ€è¦å¥½ä¿®æ”¹ï¼Œå¥½ç†è§£ï¼Œå¥½ç»´æŠ¤ï¼ŒåŸºæœ¬çš„åŠŸèƒ½è¦æœ‰ï¼Œå¼€å‘èƒ½å¿«ç‚¹ã€‚

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

çˆ¬å– investing.com çš„é‡‘ä»·æ•°æ®ï¼Œå­˜å‚¨åˆ° Supabaseï¼Œå‰ç«¯å±•ç¤ºå†å²èµ°åŠ¿å›¾è¡¨ã€‚

## ğŸ“‹ æŠ€æœ¯æ ˆå¯¹æ¯”

### Node.js æ–¹æ¡ˆï¼ˆæ¨è â­ï¼‰

| æŠ€æœ¯                  | ç‰ˆæœ¬ | ç”¨é€”          |
| --------------------- | ---- | ------------- |
| Node.js               | 18+  | è¿è¡Œç¯å¢ƒ      |
| Playwright            | æœ€æ–° | çˆ¬è™«å¼•æ“      |
| @supabase/supabase-js | æœ€æ–° | æ•°æ®åº“æ“ä½œ    |
| node-cron             | æœ€æ–° | å®šæ—¶ä»»åŠ¡      |
| Express.js            | æœ€æ–° | ç®€å• API æœåŠ¡ |

**ä¼˜åŠ¿ï¼š**

- âœ… å‰ç«¯å·¥ç¨‹å¸ˆç†Ÿæ‚‰ï¼Œå­¦ä¹ æˆæœ¬ä½
- âœ… åŒä¸€ç§è¯­è¨€ï¼Œç»´æŠ¤ç®€å•
- âœ… Playwright æ˜¯ 2024 å¹´æœ€å—æ¬¢è¿çš„çˆ¬è™«å·¥å…·
- âœ… å¯¹ investing.com åçˆ¬æ•ˆæœæœ€å¥½
- âœ… ç”Ÿæ€ç³»ç»Ÿä¸°å¯Œï¼Œéƒ¨ç½²ç®€å•
- âœ… TypeScript æ”¯æŒï¼Œä»£ç æ›´å¥å£®

**åŠ£åŠ¿ï¼š**

- âŒ æ•°æ®å¤„ç†èƒ½åŠ›ç›¸å¯¹ Python è¾ƒå¼±ï¼ˆä½†å¯¹å•å­—æ®µå¤Ÿç”¨ï¼‰

### Python æ–¹æ¡ˆ

| æŠ€æœ¯        | ç‰ˆæœ¬ | ç”¨é€”       |
| ----------- | ---- | ---------- |
| Python      | 3.9+ | è¿è¡Œç¯å¢ƒ   |
| Playwright  | æœ€æ–° | çˆ¬è™«å¼•æ“   |
| supabase-py | æœ€æ–° | æ•°æ®åº“æ“ä½œ |
| schedule    | æœ€æ–° | å®šæ—¶ä»»åŠ¡   |

**ä¼˜åŠ¿ï¼š**

- âœ… æ•°æ®å¤„ç†ç”Ÿæ€æ›´ä¸°å¯Œ
- âœ… çˆ¬è™«ç¤¾åŒºæ›´æˆç†Ÿ

**åŠ£åŠ¿ï¼š**

- âŒ éœ€è¦å­¦ä¹  Python è¯­æ³•
- âŒ éƒ¨ç½²æ—¶éœ€è¦ç®¡ç†è™šæ‹Ÿç¯å¢ƒ
- âŒ ä¸¤ç§è¯­è¨€ç»´æŠ¤æˆæœ¬é«˜

## ğŸš€ Node.js å®Œæ•´å®ç°

### 1. é¡¹ç›®åˆå§‹åŒ–

```bash
mkdir gold-price-scraper
cd gold-price-scraper
npm init -y

# å®‰è£…ä¾èµ–
npm install playwright @supabase/supabase-js node-cron dotenv
npm install -D typescript @types/node ts-node
npx playwright install chromium
```

### 2. æ ¸å¿ƒçˆ¬è™«ä»£ç 

```typescript
// src/scraper.ts
import { chromium } from "playwright";
import { createClient } from "@supabase/supabase-js";
import * as cron from "node-cron";

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_ANON_KEY!
);

interface GoldPrice {
  price: number;
  timestamp: string;
  source: string;
}

class GoldPriceScraper {
  private async scrapeGoldPrice(): Promise<number | null> {
    const browser = await chromium.launch({
      headless: true,
      args: ["--no-sandbox", "--disable-setuid-sandbox"],
    });

    try {
      const context = await browser.newContext({
        userAgent:
          "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        viewport: { width: 1280, height: 720 },
        // åæ£€æµ‹è®¾ç½®
        javaScriptEnabled: true,
        extraHTTPHeaders: {
          Accept:
            "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
          "Accept-Language": "en-US,en;q=0.5",
          "Accept-Encoding": "gzip, deflate",
          Connection: "keep-alive",
        },
      });

      const page = await context.newPage();

      // è®¾ç½®éšæœºå»¶è¿Ÿ
      await page.waitForTimeout(Math.random() * 2000 + 1000);

      // è®¿é—®é‡‘ä»·é¡µé¢
      await page.goto("https://www.investing.com/commodities/gold", {
        waitUntil: "networkidle",
      });

      // ç­‰å¾…ä»·æ ¼å…ƒç´ åŠ è½½
      await page.waitForSelector('[data-test="instrument-price-last"]', {
        timeout: 30000,
      });

      // æå–é‡‘ä»·
      const priceText = await page.textContent(
        '[data-test="instrument-price-last"]'
      );
      const price = parseFloat(priceText?.replace(/[,$]/g, "") || "0");

      console.log(`å½“å‰é‡‘ä»·: $${price}`);
      return price;
    } catch (error) {
      console.error("çˆ¬å–å¤±è´¥:", error);
      return null;
    } finally {
      await browser.close();
    }
  }

  private async saveToDatabase(price: number): Promise<void> {
    const goldPrice: GoldPrice = {
      price,
      timestamp: new Date().toISOString(),
      source: "investing.com",
    };

    const { error } = await supabase.from("gold_prices").insert(goldPrice);

    if (error) {
      console.error("æ•°æ®åº“ä¿å­˜å¤±è´¥:", error);
    } else {
      console.log("æ•°æ®ä¿å­˜æˆåŠŸ");
    }
  }

  public async run(): Promise<void> {
    const price = await this.scrapeGoldPrice();
    if (price) {
      await this.saveToDatabase(price);
    }
  }

  // å¯åŠ¨å®šæ—¶ä»»åŠ¡
  public startScheduler(): void {
    // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
    cron.schedule("0 * * * *", () => {
      console.log("æ‰§è¡Œå®šæ—¶çˆ¬å–ä»»åŠ¡...");
      this.run();
    });

    // ç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡
    this.run();
  }
}

export default GoldPriceScraper;
```

### 3. ä¸»ç¨‹åºå…¥å£

```typescript
// src/index.ts
import GoldPriceScraper from "./scraper";
import * as dotenv from "dotenv";

dotenv.config();

const scraper = new GoldPriceScraper();

// å¯åŠ¨å®šæ—¶ä»»åŠ¡
scraper.startScheduler();

console.log("é‡‘ä»·çˆ¬è™«å·²å¯åŠ¨...");

// ä¼˜é›…å…³é—­
process.on("SIGINT", () => {
  console.log("ç¨‹åºæ­£åœ¨å…³é—­...");
  process.exit(0);
});
```

### 4. ç¯å¢ƒé…ç½®

```bash
# .env
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 5. Supabase æ•°æ®è¡¨ç»“æ„

```sql
-- åœ¨Supabaseä¸­åˆ›å»ºè¡¨
CREATE TABLE gold_prices (
  id SERIAL PRIMARY KEY,
  price DECIMAL(10, 2) NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  source VARCHAR(50) NOT NULL DEFAULT 'investing.com',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_gold_prices_timestamp ON gold_prices(timestamp);
```

### 6. å‰ç«¯å±•ç¤ºé¡µé¢

```html
<!-- public/index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>é‡‘ä»·èµ°åŠ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  </head>
  <body>
    <h1>é‡‘ä»·å†å²èµ°åŠ¿</h1>
    <canvas id="goldChart" width="400" height="200"></canvas>

    <script>
      const { createClient } = supabase;
      const supabaseClient = createClient(
        "YOUR_SUPABASE_URL",
        "YOUR_SUPABASE_ANON_KEY"
      );

      async function loadGoldPrices() {
        const { data, error } = await supabaseClient
          .from("gold_prices")
          .select("price, timestamp")
          .order("timestamp", { ascending: true })
          .limit(100);

        if (error) {
          console.error("è·å–æ•°æ®å¤±è´¥:", error);
          return;
        }

        const ctx = document.getElementById("goldChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: data.map((item) =>
              new Date(item.timestamp).toLocaleDateString()
            ),
            datasets: [
              {
                label: "é‡‘ä»· (USD)",
                data: data.map((item) => item.price),
                borderColor: "rgb(255, 215, 0)",
                backgroundColor: "rgba(255, 215, 0, 0.1)",
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: false,
              },
            },
          },
        });
      }

      loadGoldPrices();
    </script>
  </body>
</html>
```

## ğŸ”§ åçˆ¬ç­–ç•¥

### 1. Playwright åæ£€æµ‹é…ç½®

```typescript
// é«˜çº§åæ£€æµ‹é…ç½®
const context = await browser.newContext({
  userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
  viewport: { width: 1920, height: 1080 },
  locale: "en-US",
  timezoneId: "America/New_York",
  permissions: ["notifications"],
  colorScheme: "light",
  extraHTTPHeaders: {
    Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
    "Accept-Language": "en-US,en;q=0.9",
    "Cache-Control": "no-cache",
    Pragma: "no-cache",
    "Sec-Fetch-Dest": "document",
    "Sec-Fetch-Mode": "navigate",
    "Sec-Fetch-Site": "none",
    "Upgrade-Insecure-Requests": "1",
  },
});

// å±è”½webdriveræ£€æµ‹
await context.addInitScript(() => {
  Object.defineProperty(navigator, "webdriver", {
    get: () => undefined,
  });

  // åˆ é™¤è‡ªåŠ¨åŒ–ç‰¹å¾
  delete window.cdc_adoQpoasnfa76pfcZLmcfl_Array;
  delete window.cdc_adoQpoasnfa76pfcZLmcfl_Promise;
  delete window.cdc_adoQpoasnfa76pfcZLmcfl_Symbol;
});
```

### 2. éšæœºå»¶è¿Ÿå’Œé‡è¯•æœºåˆ¶

```typescript
private async withRetry<T>(fn: () => Promise<T>, maxRetries = 3): Promise<T | null> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      // éšæœºå»¶è¿Ÿ 1-3ç§’
      await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
      return await fn();
    } catch (error) {
      console.log(`å°è¯• ${i + 1} å¤±è´¥:`, error);
      if (i === maxRetries - 1) return null;
    }
  }
  return null;
}
```

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### 1. Linux æœåŠ¡å™¨éƒ¨ç½²

```bash
# å®‰è£…Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£…é¡¹ç›®ä¾èµ–
npm install
npx playwright install-deps chromium

# ä½¿ç”¨PM2ç®¡ç†è¿›ç¨‹
npm install -g pm2
pm2 start src/index.ts --name gold-scraper --interpreter ts-node
pm2 startup
pm2 save
```

### 2. Docker éƒ¨ç½²

```dockerfile
# Dockerfile
FROM node:18-alpine

RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont

ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

WORKDIR /app
COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

EXPOSE 3000
CMD ["npm", "start"]
```

### 3. Windows éƒ¨ç½²ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘ç¯å¢ƒ
npm run dev

# æˆ–è€…ä½¿ç”¨nodemon
npm install -g nodemon
nodemon src/index.ts
```

## ğŸ“Š æ€§èƒ½ä¸ç»´æŠ¤

### 1. é”™è¯¯ç›‘æ§

```typescript
// æ·»åŠ é”™è¯¯ç›‘æ§å’Œæ—¥å¿—
import winston from "winston";

const logger = winston.createLogger({
  level: "info",
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: "error.log", level: "error" }),
    new winston.transports.File({ filename: "combined.log" }),
    new winston.transports.Console(),
  ],
});
```

### 2. æ•°æ®å¤‡ä»½å’Œæ¢å¤

```typescript
// å®šæœŸå¤‡ä»½æ•°æ®
cron.schedule("0 2 * * *", async () => {
  const { data } = await supabase
    .from("gold_prices")
    .select("*")
    .gte("timestamp", new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());

  // ä¿å­˜åˆ°æ–‡ä»¶
  fs.writeFileSync(`backup-${Date.now()}.json`, JSON.stringify(data));
});
```

## ğŸ¯ æ€»ç»“

**ä¸ºä»€ä¹ˆé€‰æ‹© Node.js + Playwrightï¼š**

1. **å¼€å‘æ•ˆç‡é«˜** - å‰ç«¯å·¥ç¨‹å¸ˆé›¶å­¦ä¹ æˆæœ¬
2. **ç»´æŠ¤æˆæœ¬ä½** - ä¸€ç§è¯­è¨€ç»´æŠ¤æ•´ä¸ªé¡¹ç›®
3. **æŠ€æœ¯å…ˆè¿›æ€§** - Playwright æ˜¯ç›®å‰æœ€å¼ºå¤§çš„çˆ¬è™«å·¥å…·
4. **åçˆ¬èƒ½åŠ›å¼º** - ä¸“é—¨é’ˆå¯¹ç°ä»£åçˆ¬ç½‘ç«™è®¾è®¡
5. **ç”Ÿæ€ä¸°å¯Œ** - npm ç”Ÿæ€ç³»ç»Ÿå®Œå–„
6. **éƒ¨ç½²çµæ´»** - æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼

è¿™ä¸ªæ–¹æ¡ˆå¯ä»¥è®©ä½ å¿«é€Ÿä¸Šæ‰‹ï¼Œä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯å­¦ä¹ æ–°è¯­è¨€ã€‚ä»£ç ç®€æ´æ˜“æ‡‚ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œå®Œå…¨æ»¡è¶³ä½ çš„éœ€æ±‚ï¼
